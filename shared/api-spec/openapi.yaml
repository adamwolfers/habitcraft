openapi: 3.0.3
info:
  title: HabitCraft API
  description: |
    REST API specification for the HabitCraft application.
    All backend implementations should follow this specification.
  version: 1.0.0
  contact:
    name: API Support
  license:
    name: MIT

servers:
  - url: http://localhost:3000/api/v1
    description: Local development server
  - url: https://api.habitcraft.example.com/v1
    description: Production server

tags:
  - name: Health
    description: Health check endpoints
  - name: Auth
    description: Authentication and authorization
  - name: Users
    description: User profile management
  - name: Habits
    description: Habit CRUD operations
  - name: Completions
    description: Habit completion tracking

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns API health status
      operationId: healthCheck
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string
                    example: 1.0.0

  /hello:
    get:
      tags:
        - Health
      summary: Hello World endpoint
      description: Simple hello world response for testing
      operationId: helloWorld
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Hello World!

  /auth/register:
    post:
      tags:
        - Auth
      summary: Register new user
      description: |
        Create a new user account. On success, sets HttpOnly cookies for authentication:
        - accessToken (15 min expiry)
        - refreshToken (7 day expiry)
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - name
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: SecurePass123!
                name:
                  type: string
                  example: John Doe
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      tags:
        - Auth
      summary: Login user
      description: |
        Authenticate user with email and password. On success, sets HttpOnly cookies:
        - accessToken (15 min expiry)
        - refreshToken (7 day expiry)
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: SecurePass123!
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/refresh:
    post:
      tags:
        - Auth
      summary: Refresh access token
      description: |
        Get new tokens using the refresh token from cookies.
        Implements token rotation:
        - Validates refresh token signature and database record
        - Revokes the old refresh token
        - Generates new access AND refresh tokens
        - Sets new HttpOnly cookies for both tokens
      operationId: refreshToken
      responses:
        '200':
          description: Tokens refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                    description: New access token (also set as HttpOnly cookie)
              example:
                accessToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        '400':
          description: Refresh token missing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Refresh token is required"
        '401':
          description: Invalid, expired, or revoked refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                expired:
                  value:
                    error: "Refresh token expired"
                revoked:
                  value:
                    error: "Token has been revoked"
                invalid:
                  value:
                    error: "Invalid refresh token"

  /auth/logout:
    post:
      tags:
        - Auth
      summary: Logout user
      description: |
        Revoke the refresh token and clear authentication cookies.
        The refresh token is marked as revoked in the database.
      operationId: logout
      responses:
        '200':
          description: Logged out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
              example:
                message: "Logged out successfully"

  /users/me:
    get:
      tags:
        - Users
      summary: Get current user profile
      description: Get the authenticated user's profile. Requires valid access token in cookie.
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Users
      summary: Update current user profile
      description: |
        Update the authenticated user's profile. At least one field (name or email) must be provided.
        Email updates will normalize to lowercase and check for uniqueness.
      operationId: updateCurrentUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 100
                  example: John Doe
                  description: User's display name
                email:
                  type: string
                  format: email
                  example: newemail@example.com
                  description: User's email address (must be unique)
            examples:
              updateName:
                summary: Update name only
                value:
                  name: New Name
              updateEmail:
                summary: Update email only
                value:
                  email: newemail@example.com
              updateBoth:
                summary: Update both name and email
                value:
                  name: New Name
                  email: newemail@example.com
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Validation error or no fields provided
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: array
                    items:
                      type: object
                      properties:
                        msg:
                          type: string
                        path:
                          type: string
              examples:
                noFields:
                  summary: No fields provided
                  value:
                    errors:
                      - msg: "At least one field (name or email) is required"
                invalidEmail:
                  summary: Invalid email format
                  value:
                    errors:
                      - msg: "Invalid email format"
                        path: "email"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email is already in use by another user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Email is already in use"

  /users/me/password:
    put:
      tags:
        - Users
      summary: Change password
      description: |
        Change the authenticated user's password. Requires current password verification.
        On success, all refresh tokens are revoked (user must re-login on other devices).
      operationId: changePassword
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - currentPassword
                - newPassword
                - confirmPassword
              properties:
                currentPassword:
                  type: string
                  format: password
                  description: User's current password
                newPassword:
                  type: string
                  format: password
                  minLength: 8
                  description: New password (minimum 8 characters)
                confirmPassword:
                  type: string
                  format: password
                  description: Must match newPassword
            example:
              currentPassword: "OldPass123!"
              newPassword: "NewSecure456!"
              confirmPassword: "NewSecure456!"
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
              example:
                message: "Password changed successfully"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: array
                    items:
                      type: object
                      properties:
                        msg:
                          type: string
                        path:
                          type: string
              examples:
                missingField:
                  summary: Missing required field
                  value:
                    errors:
                      - msg: "Current password is required"
                        path: "currentPassword"
                passwordTooShort:
                  summary: Password too short
                  value:
                    errors:
                      - msg: "New password must be at least 8 characters"
                        path: "newPassword"
                passwordMismatch:
                  summary: Passwords don't match
                  value:
                    errors:
                      - msg: "Passwords do not match"
                        path: "confirmPassword"
        '401':
          description: Invalid current password or missing authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Invalid current password"
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Too many requests (rate limited)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Too many password change attempts, please try again later"

  /habits:
    get:
      tags:
        - Habits
      summary: List habits
      description: Get all habits for the authenticated user
      operationId: listHabits
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          description: Filter by habit status
          schema:
            type: string
            enum: [active, archived]
      responses:
        '200':
          description: List of habits
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Habit'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Habits
      summary: Create habit
      description: Create a new habit
      operationId: createHabit
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HabitInput'
      responses:
        '201':
          description: Habit created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Habit'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /habits/{habitId}:
    put:
      tags:
        - Habits
      summary: Update habit
      description: Update an existing habit
      operationId: updateHabit
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/HabitId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HabitInput'
      responses:
        '200':
          description: Habit updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Habit'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Habits
      summary: Delete habit
      description: Delete a habit
      operationId: deleteHabit
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/HabitId'
      responses:
        '204':
          description: Habit deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /habits/{habitId}/completions:
    get:
      tags:
        - Completions
      summary: List completions
      description: Get all completions for a habit
      operationId: listCompletions
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/HabitId'
        - name: startDate
          in: query
          description: Filter completions from this date
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          description: Filter completions until this date
          schema:
            type: string
            format: date
      responses:
        '200':
          description: List of completions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Completion'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      tags:
        - Completions
      summary: Mark habit complete
      description: Mark a habit as completed for a specific date
      operationId: createCompletion
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/HabitId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - date
              properties:
                date:
                  type: string
                  format: date
                  example: "2024-01-15"
                notes:
                  type: string
                  example: "Went for a 30-minute run"
      responses:
        '201':
          description: Completion recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Completion'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Already completed for this date
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /habits/{habitId}/completions/{date}:
    delete:
      tags:
        - Completions
      summary: Remove completion
      description: Remove a habit completion for a specific date
      operationId: deleteCompletion
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/HabitId'
        - name: date
          in: path
          required: true
          description: Date of the completion to remove
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Completion removed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  habitId:
                    type: string
                  date:
                    type: string
                    format: date
              example:
                message: "Completion deleted successfully"
                habitId: "abc123"
                date: "2024-01-15"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    HabitId:
      name: habitId
      in: path
      required: true
      description: Habit identifier
      schema:
        type: string
        format: uuid

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000
        email:
          type: string
          format: email
          example: user@example.com
        name:
          type: string
          example: John Doe
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    AuthResponse:
      type: object
      description: |
        Authentication response. Tokens are set as HttpOnly cookies, not returned in body.
        - accessToken cookie: 15 minute expiry
        - refreshToken cookie: 7 day expiry
      properties:
        user:
          $ref: '#/components/schemas/User'
      example:
        user:
          id: "123e4567-e89b-12d3-a456-426614174000"
          email: "user@example.com"
          name: "John Doe"
          createdAt: "2024-01-15T10:30:00Z"

    HabitInput:
      type: object
      required:
        - name
        - frequency
      properties:
        name:
          type: string
          example: Morning Exercise
          minLength: 1
          maxLength: 100
        description:
          type: string
          example: 30 minutes of cardio exercise
          maxLength: 500
        frequency:
          type: string
          enum: [daily, weekly]
          example: daily
        targetDays:
          type: array
          description: Days of the week for weekly habits (0=Sunday, 6=Saturday)
          items:
            type: integer
            minimum: 0
            maximum: 6
          example: [1, 3, 5]
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
          example: "#3B82F6"
        icon:
          type: string
          example: "üèÉ"

    Habit:
      allOf:
        - $ref: '#/components/schemas/HabitInput'
        - type: object
          properties:
            id:
              type: string
              format: uuid
            userId:
              type: string
              format: uuid
            status:
              type: string
              enum: [active, archived]
              example: active
            createdAt:
              type: string
              format: date-time
            updatedAt:
              type: string
              format: date-time

    Completion:
      type: object
      properties:
        id:
          type: string
          format: uuid
        habitId:
          type: string
          format: uuid
        date:
          type: string
          format: date
          example: "2024-01-15"
        notes:
          type: string
          example: "Went for a 30-minute run"
        createdAt:
          type: string
          format: date-time
      example:
        id: "abc123"
        habitId: "habit-456"
        date: "2024-01-15"
        notes: "Went for a 30-minute run"
        createdAt: "2024-01-15T08:30:00Z"

    Error:
      type: object
      properties:
        error:
          type: string
          example: Resource not found
        message:
          type: string
          example: The requested habit does not exist
        statusCode:
          type: integer
          example: 404

  responses:
    BadRequest:
      description: Bad request - validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Unauthorized - invalid or missing token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Forbidden:
      description: Forbidden - access denied to this resource
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Access denied"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
